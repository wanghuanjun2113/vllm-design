<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½ç½®æ— å…³Chunkç¼“å­˜ - æµç¨‹æ—¶åºå›¾</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .nav {
            background: #f8f9fa;
            padding: 20px 40px;
            border-bottom: 2px solid #e9ecef;
        }

        .nav ul {
            list-style: none;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .nav a {
            color: #667eea;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .nav a:hover {
            background: #667eea;
            color: white;
        }

        .content {
            padding: 40px;
        }

        .section {
            margin-bottom: 60px;
        }

        .section h2 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .section h3 {
            color: #764ba2;
            font-size: 1.5em;
            margin: 30px 0 15px 0;
        }

        .diagram-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 30px;
            margin: 20px 0;
            overflow-x: auto;
            border: 1px solid #e9ecef;
        }

        .description {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .description h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .description ul {
            margin-left: 20px;
        }

        .description li {
            margin: 8px 0;
        }

        .highlight {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }

        .performance {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            font-weight: 500;
        }

        .step {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
        }

        .step-number {
            display: inline-block;
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            border-radius: 50%;
            font-weight: bold;
            margin-right: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
        }

        table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }

        table tr:hover {
            background: #f8f9fa;
        }

        .class-info {
            background: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
        }

        .class-info code {
            background: white;
            padding: 2px 6px;
            border-radius: 3px;
            color: #667eea;
            font-family: 'Courier New', monospace;
        }

        .footer {
            background: #f8f9fa;
            padding: 30px;
            text-align: center;
            color: #6c757d;
            border-top: 1px solid #dee2e6;
        }

        pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 10px 0;
        }

        code {
            font-family: 'Courier New', monospace;
        }

        .mermaid {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ ä½ç½®æ— å…³Chunkç¼“å­˜ - æµç¨‹æ—¶åºå›¾</h1>
            <p>Position-Agnostic Chunk Cache - Sequence Diagrams</p>
        </div>

        <div class="nav">
            <ul>
                <li><a href="#overview">æ¦‚è¿°</a></li>
                <li><a href="#flow1">æµç¨‹1: ç¼“å­˜æœªå‘½ä¸­</a></li>
                <li><a href="#flow2">æµç¨‹2: ç¼“å­˜å‘½ä¸­</a></li>
                <li><a href="#flow3">æµç¨‹3: ä½ç½®ç¼–ç å¤„ç†</a></li>
                <li><a href="#flow4">æµç¨‹4: Attention Maskæ„å»º</a></li>
                <li><a href="#classes">æ¶‰åŠçš„ç±»</a></li>
            </ul>
        </div>

        <div class="content">
            <!-- æ¦‚è¿° -->
            <div id="overview" class="section">
                <h2>ğŸ“‹ æ¦‚è¿°</h2>

                <div class="description">
                    <h4>ä»€ä¹ˆæ˜¯ä½ç½®æ— å…³Chunkç¼“å­˜ï¼Ÿ</h4>
                    <ul>
                        <li><strong>ä½ç½®æ— å…³ç¼“å­˜</strong>ï¼šChunk hashä»…åŸºäºtokenå†…å®¹ï¼Œä¸åŒ…å«ä½ç½®ä¿¡æ¯</li>
                        <li><strong>è™šæ‹Ÿä½ç½®è®¡ç®—</strong>ï¼šæ‰€æœ‰chunkåœ¨ç»Ÿä¸€è™šæ‹Ÿä½ç½®è®¡ç®—KVï¼Œä½¿ç”¨æ—¶é‡æ˜ å°„åˆ°å®é™…ä½ç½®</li>
                        <li><strong>Chunkéš”ç¦»æ³¨æ„åŠ›</strong>ï¼šé€šè¿‡è‡ªå®šä¹‰attention maskå®ç°chunké—´çš„éš”ç¦»</li>
                        <li><strong>ç‹¬ç«‹å†…å­˜æ± </strong>ï¼šä¸ä¸»KV cacheåˆ†ç¦»çš„chunkç¼“å­˜æ± ï¼ˆé»˜è®¤2GBï¼‰</li>
                    </ul>
                </div>

                <div class="performance">
                    ğŸ¯ <strong>æ€§èƒ½é¢„æœŸï¼š</strong> å•ä¸ªchunkç¼“å­˜å‘½ä¸­çº¦12xåŠ é€Ÿï¼ˆ5ms vs 60msï¼‰
                </div>
            </div>

            <!-- æµç¨‹1ï¼šç¼“å­˜æœªå‘½ä¸­ -->
            <div id="flow1" class="section">
                <h2>ğŸ”„ æµç¨‹1ï¼šç¼“å­˜æœªå‘½ä¸­ - ç”ŸæˆChunk KVå¹¶ç¼“å­˜</h2>

                <div class="description">
                    <h4>åœºæ™¯æè¿°</h4>
                    <p>ç”¨æˆ·è¯·æ±‚ï¼š<code>"You are helpful. # # Doc1 # # What?"</code></p>
                    <p>è¿™æ˜¯ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼Œæ‰€æœ‰chunkéƒ½éœ€è¦è®¡ç®—å¹¶ç¼“å­˜ã€‚</p>
                </div>

                <h3>æ—¶åºå›¾</h3>
                <div class="diagram-container">
                    <div class="mermaid">
sequenceDiagram
    autonumber
    participant User
    participant LLMEngine as LLMEngine
    participant InputProcessor as InputProcessor<br/>(ä¿®æ”¹)
    participant ChunkTokenParser as ChunkTokenParser<br/>(æ–°å¢)
    participant ChunkCacheEngine as ChunkCacheEngine<br/>(æ–°å¢)
    participant ChunkHashIndex as ChunkHashIndex<br/>(æ–°å¢)
    participant GPUModelRunner as GPUModelRunner<br/>(ä¿®æ”¹)
    participant ChunkKVPool as ChunkKVPool<br/>(æ–°å¢)
    participant ChunkStorageManager as ChunkStorageManager<br/>(æ–°å¢)
    participant PositionRemapper as PositionRemapper<br/>(æ–°å¢)
    participant AttentionMaskBuilder as AttentionMaskBuilder<br/>(æ–°å¢)
    participant AscendSFABackend as AscendSFABackend<br/>(ä¿®æ”¹)

    User->>LLMEngine: 1. å‘é€è¯·æ±‚<br/>"You are helpful. # # Doc1 # # What?"
    LLMEngine->>InputProcessor: 2. process_inputs()

    Note over InputProcessor: æ£€æµ‹åˆ†éš”ç¬¦ " # # "
    InputProcessor->>InputProcessor: 3. _detect_chunked_prompt()<br/>è¿”å›: True

    InputProcessor->>ChunkTokenParser: 4. parse(tokens, " # # ")

    Note over ChunkTokenParser: è§£æchunked prompt
    ChunkTokenParser->>ChunkTokenParser: 5. åˆ†å‰²tokenåºåˆ—<br/>sys_prompt: [1,2,3]<br/>chunks: [[10,11,...,200]]<br/>question: [100,101]
    ChunkTokenParser->>ChunkTokenParser: 6. è®¡ç®—chunk_boundaries<br/>[(0,3), (3,203), (203,205)]
    ChunkTokenParser-->>InputProcessor: 7. è¿”å› ChunkedPrompt

    InputProcessor->>ChunkCacheEngine: 8. lookup(chunks)

    loop æ¯ä¸ªchunk
        ChunkCacheEngine->>ChunkTokenParser: 9. compute_hash(chunk_tokens)
        ChunkTokenParser-->>ChunkCacheEngine: 10. è¿”å› content_hash<br/>(XXHash128)

        Note over ChunkCacheEngine: sys_prompt: hash_abc<br/>Doc1: hash_def
        ChunkCacheEngine->>ChunkHashIndex: 11. lookup(hash_abc)
        ChunkHashIndex-->>ChunkCacheEngine: 12. è¿”å› None [MISS]
        ChunkCacheEngine->>ChunkHashIndex: 13. lookup(hash_def)
        ChunkHashIndex-->>ChunkCacheEngine: 14. è¿”å› None [MISS]
    end

    ChunkCacheEngine-->>InputProcessor: 15. è¿”å› æ‰€æœ‰chunkæœªå‘½ä¸­

    InputProcessor->>GPUModelRunner: 16. get_or_compute_chunks(chunks)

    loop æ¯ä¸ªæœªå‘½ä¸­çš„chunk
        GPUModelRunner->>GPUModelRunner: 17. compute_chunk_kv()<br/>tokens=sys_prompt

        Note over GPUModelRunner: åœ¨è™šæ‹Ÿä½ç½®è®¡ç®—KV
        GPUModelRunner->>ChunkKVPool: 18. allocate(num_tokens)
        ChunkKVPool-->>GPUModelRunner: 19. è¿”å› block_ids [100, 101]

        GPUModelRunner->>GPUModelRunner: 20. æ‰§è¡Œmodel.forward()<br/>position=[0, 3)<br/>åº”ç”¨è™šæ‹Ÿä½ç½®RoPE

        GPUModelRunner->>GPUModelRunner: 21. åˆ›å»º ChunkKV{<br/>chunk_key: ChunkKey(hash_abc),<br/>block_ids: [100, 101],<br/>virtual_position: [0, 3)<br/>}

        GPUModelRunner->>ChunkCacheEngine: 22. store(hash_abc, chunk_kv)
        ChunkCacheEngine->>ChunkStorageManager: 23. put(hash_abc, chunk_kv)
        ChunkStorageManager-->>ChunkCacheEngine: 24. å­˜å‚¨æˆåŠŸ
        ChunkCacheEngine-->>GPUModelRunner: 25. å­˜å‚¨æˆåŠŸ

        Note over GPUModelRunner: é‡å¤å¤„ç† Doc1 chunk<br/>compute_chunk_kv(tokens=Doc1)<br/>â†’ block_ids [102, 103, ...]
    end

    GPUModelRunner->>PositionRemapper: 26. remap(sys_prompt_kv, dst_position=0)

    Note over PositionRemapper: æ‹·è´å¹¶é‡æ˜ å°„åˆ°å®é™…ä½ç½®
    PositionRemapper->>ChunkKVPool: 27. allocate_main_kv(num_tokens)
    ChunkKVPool-->>PositionRemapper: 28. è¿”å› main_block_ids [5000, 5001]

    PositionRemapper->>PositionRemapper: 29. æ‹·è´ KVæ•°æ®<br/>100â†’5000, 101â†’5001
    PositionRemapper->>PositionRemapper: 30. åº”ç”¨ä½ç½®0çš„RoPEç¼–ç <br/>è¦†ç›–è™šæ‹Ÿä½ç½®ç¼–ç 

    PositionRemapper-->>GPUModelRunner: 31. è¿”å› RemappedChunkKV{<br/>block_ids: [5000, 5001],<br/>position: [0, 3)<br/>}

    GPUModelRunner->>PositionRemapper: 32. remap(Doc1_kv, dst_position=3)

    Note over PositionRemapper: é‡å¤å¤„ç† Doc1
    PositionRemapper->>ChunkKVPool: 33. allocate_main_kv(num_tokens)
    ChunkKVPool-->>PositionRemapper: 34. è¿”å› [5002, 5003, ...]
    PositionRemapper->>PositionRemapper: 35. æ‹·è´ KV + åº”ç”¨ä½ç½®3çš„RoPE

    PositionRemapper-->>GPUModelRunner: 36. è¿”å› RemappedChunkKV{<br/>block_ids: [5002, 5003, ...],<br/>position: [3, 203)<br/>}

    GPUModelRunner->>AttentionMaskBuilder: 37. get_chunk_aware_mask(<br/>chunk_boundaries,<br/>seq_len)

    Note over AttentionMaskBuilder: æ„å»ºchunkéš”ç¦»attention mask
    AttentionMaskBuilder->>AttentionMaskBuilder: 38. ä¸ºæ¯ä¸ªtokenåˆ†é…chunk_id<br/>sys_prompt: -1<br/>Doc1: 0<br/>question: -2

    AttentionMaskBuilder->>AttentionMaskBuilder: 39. æ„å»ºattention maskçŸ©é˜µ<br/>sys_prompt: æ ‡å‡†causal<br/>Doc1: å¯çœ‹sys_prompt+åŒchunk<br/>question: å¯çœ‹æ‰€æœ‰

    AttentionMaskBuilder-->>GPUModelRunner: 40. è¿”å› chunk_attn_mask

    GPUModelRunner->>AscendSFABackend: 41. forward(<br/>query, key, value,<br/>chunk_attn_mask,<br/>remapped_kv_blocks)

    Note over AscendSFABackend: æ‰§è¡Œæ¨ç†
    AscendSFABackend->>AscendSFABackend: 42. åº”ç”¨chunk-aware mask
    AscendSFABackend->>AscendSFABackend: 43. æ‰§è¡Œæ³¨æ„åŠ›è®¡ç®—
    AscendSFABackend-->>GPUModelRunner: 44. è¿”å› hidden_states

    GPUModelRunner->>GPUModelRunner: 45. ç”Ÿæˆoutput tokens
    GPUModelRunner-->>LLMEngine: 46. è¿”å›ç”Ÿæˆç»“æœ
    LLMEngine-->>User: 47. è¿”å›æœ€ç»ˆè¾“å‡º
                    </div>
                </div>

                <div class="description">
                    <h4>å…³é”®æ­¥éª¤è¯´æ˜</h4>
                    <div class="step">
                        <span class="step-number">1</span>
                        <strong>æ£€æµ‹åˆ†éš”ç¬¦</strong>ï¼šInputProcessoræ£€æµ‹åˆ°`# #`åˆ†éš”ç¬¦ï¼Œåˆ¤æ–­ä¸ºchunked prompt
                    </div>
                    <div class="step">
                        <span class="step-number">2</span>
                        <strong>è§£æchunked prompt</strong>ï¼šChunkTokenParserå°†promptåˆ†å‰²ä¸ºsys_promptã€chunkså’Œquestion
                    </div>
                    <div class="step">
                        <span class="step-number">3</span>
                        <strong>å“ˆå¸ŒæŸ¥æ‰¾</strong>ï¼šå¯¹æ¯ä¸ªchunkè®¡ç®—å†…å®¹å“ˆå¸Œï¼Œåœ¨ChunkHashIndexä¸­æŸ¥æ‰¾
                    </div>
                    <div class="step">
                        <span class="step-number">4</span>
                        <strong>è®¡ç®—Chunk KV</strong>ï¼šåœ¨è™šæ‹Ÿä½ç½®è®¡ç®—chunkçš„KV cache
                    </div>
                    <div class="step">
                        <span class="step-number">5</span>
                        <strong>ç¼“å­˜Chunk KV</strong>ï¼šå°†è®¡ç®—å¥½çš„chunk KVå­˜å‚¨åˆ°ChunkStorageManager
                    </div>
                    <div class="step">
                        <span class="step-number">6</span>
                        <strong>é‡æ˜ å°„åˆ°å®é™…ä½ç½®</strong>ï¼šPositionRemapperæ‹·è´KVå¹¶åº”ç”¨å®é™…ä½ç½®çš„RoPEç¼–ç 
                    </div>
                    <div class="step">
                        <span class="step-number">7</span>
                        <strong>æ„å»ºAttention Mask</strong>ï¼šç”Ÿæˆchunkéš”ç¦»çš„attention mask
                    </div>
                    <div class="step">
                        <span class="step-number">8</span>
                        <strong>æ‰§è¡Œæ¨ç†</strong>ï¼šAscendSFABackendæ‰§è¡Œæ³¨æ„åŠ›è®¡ç®—å¹¶ç”Ÿæˆç»“æœ
                    </div>
                </div>

                <div class="performance">
                    â±ï¸ <strong>æ€§èƒ½åˆ†æï¼š</strong> ç¼“å­˜æœªå‘½ä¸­æ—¶ï¼Œæ€»è€—æ—¶çº¦55msï¼ˆè®¡ç®—50ms + æ‹·è´5msï¼‰
                </div>
            </div>

            <!-- æµç¨‹2ï¼šç¼“å­˜å‘½ä¸­ -->
            <div id="flow2" class="section">
                <h2>âœ… æµç¨‹2ï¼šç¼“å­˜å‘½ä¸­ - æ‹·è´æ‹¼æ¥KVå¹¶æ¨ç†</h2>

                <div class="description">
                    <h4>åœºæ™¯æè¿°</h4>
                    <p>ç”¨æˆ·è¯·æ±‚ï¼š<code>"Different sys. # # Doc1 # # Tell me more"</code></p>
                    <p>Doc1 chunkå·²ç»åœ¨ç¼“å­˜ä¸­ï¼Œå¯ä»¥ç›´æ¥å¤ç”¨ï¼Œæ— éœ€é‡æ–°è®¡ç®—ï¼</p>
                </div>

                <h3>æ—¶åºå›¾</h3>
                <div class="diagram-container">
                    <div class="mermaid">
sequenceDiagram
    autonumber
    participant User
    participant LLMEngine as LLMEngine
    participant InputProcessor as InputProcessor<br/>(ä¿®æ”¹)
    participant ChunkTokenParser as ChunkTokenParser<br/>(æ–°å¢)
    participant ChunkCacheEngine as ChunkCacheEngine<br/>(æ–°å¢)
    participant ChunkHashIndex as ChunkHashIndex<br/>(æ–°å¢)
    participant GPUModelRunner as GPUModelRunner<br/>(ä¿®æ”¹)
    participant ChunkStorageManager as ChunkStorageManager<br/>(æ–°å¢)
    participant PositionRemapper as PositionRemapper<br/>(æ–°å¢)
    participant AttentionMaskBuilder as AttentionMaskBuilder<br/>(æ–°å¢)
    participant AscendSFABackend as AscendSFABackend<br/>(ä¿®æ”¹)

    User->>LLMEngine: 1. å‘é€è¯·æ±‚<br/>"Different sys. # # Doc1 # # Tell me more"
    LLMEngine->>InputProcessor: 2. process_inputs()

    InputProcessor->>InputProcessor: 3. _detect_chunked_prompt()<br/>è¿”å›: True

    InputProcessor->>ChunkTokenParser: 4. parse(tokens, " # # ")

    Note over ChunkTokenParser: è§£æchunked prompt
    ChunkTokenParser->>ChunkTokenParser: 5. åˆ†å‰²tokenåºåˆ—<br/>sys_prompt: [5,6,7] (ä¸åŒ!)<br/>chunks: [[10,11,...,200]] (ç›¸åŒDoc1)<br/>question: [200,201]
    ChunkTokenParser-->>InputProcessor: 6. è¿”å› ChunkedPrompt

    InputProcessor->>ChunkCacheEngine: 7. lookup(chunks)

    ChunkCacheEngine->>ChunkTokenParser: 8. compute_hash(sys_prompt)
    ChunkTokenParser-->>ChunkCacheEngine: 9. è¿”å› hash_xyz

    ChunkCacheEngine->>ChunkHashIndex: 10. lookup(hash_xyz)
    ChunkHashIndex-->>ChunkCacheEngine: 11. è¿”å› None [MISS]

    ChunkCacheEngine->>ChunkTokenParser: 12. compute_hash(Doc1)
    ChunkTokenParser-->>ChunkCacheEngine: 13. è¿”å› hash_def

    Note over ChunkCacheEngine,ChunkHashIndex: å…³é”®ï¼šDoc1å·²ç»åœ¨ç¼“å­˜ä¸­ï¼
    ChunkCacheEngine->>ChunkHashIndex: 14. lookup(hash_def)
    ChunkHashIndex-->>ChunkCacheEngine: 15. è¿”å› ChunkKV [HIT] âœ“

    ChunkCacheEngine-->>InputProcessor: 16. è¿”å› {<br/>sys_prompt: MISS,<br/>Doc1: HIT (cached_kv)<br/>}

    InputProcessor->>GPUModelRunner: 17. get_or_compute_chunks(chunks)

    GPUModelRunner->>GPUModelRunner: 18. compute_chunk_kv(<br/>tokens=sys_prompt,<br/>position=0)

    Note over GPUModelRunner: åªè®¡ç®—æœªå‘½ä¸­çš„sys_prompt
    GPUModelRunner->>ChunkKVPool: 19. allocate(num_tokens)
    GPUModelRunner->>GPUModelRunner: 20. æ‰§è¡Œmodel.forward()
    GPUModelRunner->>ChunkCacheEngine: 21. store(hash_xyz, chunk_kv)
    ChunkCacheEngine->>ChunkStorageManager: 22. put(hash_xyz, chunk_kv)
    ChunkCacheEngine-->>GPUModelRunner: 23. å­˜å‚¨æˆåŠŸ

    Note over GPUModelRunner: Doc1ä»ç¼“å­˜è·å–ï¼Œè·³è¿‡è®¡ç®—ï¼
    GPUModelRunner->>ChunkCacheEngine: 24. lookup(hash_def)
    ChunkCacheEngine-->>GPUModelRunner: 25. è¿”å› cached_Doc1_kv

    GPUModelRunner->>PositionRemapper: 26. remap(sys_prompt_kv, dst_position=0)

    Note over PositionRemapper: é‡æ˜ å°„sys_prompt
    PositionRemapper->>ChunkKVPool: 27. allocate_main_kv(num_tokens)
    ChunkKVPool-->>PositionRemapper: 28. è¿”å› [6000, 6001]
    PositionRemapper->>PositionRemapper: 29. æ‹·è´ KV + åº”ç”¨ä½ç½®0çš„RoPE
    PositionRemapper-->>GPUModelRunner: 30. è¿”å› RemappedChunkKV{<br/>block_ids: [6000, 6001],<br/>position: [0, 3)<br/>}

    GPUModelRunner->>PositionRemapper: 31. remap(Doc1_kv, dst_position=3)

    Note over PositionRemapper: ç›´æ¥ä»ç¼“å­˜æ‹·è´Doc1ï¼Œæ— éœ€è®¡ç®—ï¼
    PositionRemapper->>ChunkKVPool: 32. allocate_main_kv(num_tokens)
    ChunkKVPool-->>PositionRemapper: 33. è¿”å› [6002, 6003, ...]

    Note over PositionRemapper: å…³é”®ï¼šè·³è¿‡KVè®¡ç®—ï¼Œç›´æ¥æ‹·è´+é‡æ˜ å°„
    PositionRemapper->>PositionRemapper: 34. æ‹·è´ cached KV<br/>ä»ç¼“å­˜è¯»å–ï¼Œæ— éœ€è®¡ç®—
    PositionRemapper->>PositionRemapper: 35. åº”ç”¨ä½ç½®3çš„RoPE<br/>è¦†ç›–è™šæ‹Ÿä½ç½®ç¼–ç 

    PositionRemapper-->>GPUModelRunner: 36. è¿”å› RemappedChunkKV{<br/>block_ids: [6002, 6003, ...],<br/>position: [3, 203)<br/>}

    GPUModelRunner->>GPUModelRunner: 37. è®¡ç®—question KV<br/>forward(question_tokens)

    GPUModelRunner->>GPUModelRunner: 38. æ‹¼æ¥æ‰€æœ‰KV<br/>sys_prompt: [6000, 6001]<br/>Doc1: [6002, 6003, ...]<br/>question: [6100, 6101]<br/>â†’ merged_blocks

    GPUModelRunner->>AttentionMaskBuilder: 39. get_chunk_aware_mask(<br/>chunk_boundaries,<br/>seq_len)

    Note over AttentionMaskBuilder: æ„å»ºæ–°çš„chunkéš”ç¦»mask
    AttentionMaskBuilder->>AttentionMaskBuilder: 40. chunk_idsåˆ†é…<br/>sys_prompt: -1<br/>Doc1: 0<br/>question: -2
    AttentionMaskBuilder->>AttentionMaskBuilder: 41. åº”ç”¨chunkéš”ç¦»è§„åˆ™<br/>Doc1ä¸èƒ½çœ‹æ–°sys_promptçš„token
    AttentionMaskBuilder-->>GPUModelRunner: 42. è¿”å› chunk_attn_mask

    GPUModelRunner->>AscendSFABackend: 43. forward(<br/>query, key, value,<br/>chunk_attn_mask,<br/>merged_kv_blocks)

    Note over AscendSFABackend: æ‰§è¡Œæ¨ç†
    AscendSFABackend->>AscendSFABackend: 44. åº”ç”¨chunk-aware mask
    AscendSFABackend->>AscendSFABackend: 45. æ‰§è¡Œæ³¨æ„åŠ›è®¡ç®—
    AscendSFABackend-->>GPUModelRunner: 46. è¿”å› hidden_states

    GPUModelRunner->>GPUModelRunner: 47. ç”Ÿæˆoutput tokens
    GPUModelRunner-->>LLMEngine: 48. è¿”å›ç”Ÿæˆç»“æœ
    LLMEngine-->>User: 49. è¿”å›æœ€ç»ˆè¾“å‡º
                    </div>
                </div>

                <div class="description">
                    <h4>æ€§èƒ½å¯¹æ¯”</h4>
                    <table>
                        <tr>
                            <th>æ­¥éª¤</th>
                            <th>ç¼“å­˜æœªå‘½ä¸­</th>
                            <th>ç¼“å­˜å‘½ä¸­</th>
                        </tr>
                        <tr>
                            <td>å“ˆå¸ŒæŸ¥æ‰¾</td>
                            <td>MISS</td>
                            <td>HIT</td>
                        </tr>
                        <tr>
                            <td>KVè®¡ç®—</td>
                            <td>âœ“ (50ms)</td>
                            <td>âœ— (è·³è¿‡)</td>
                        </tr>
                        <tr>
                            <td>ç¼“å­˜å­˜å‚¨</td>
                            <td>âœ“ (éœ€è¦)</td>
                            <td>âœ— (è·³è¿‡)</td>
                        </tr>
                        <tr>
                            <td>KVæ‹·è´</td>
                            <td>âœ“ (3-5ms)</td>
                            <td>âœ“ (3-5ms)</td>
                        </tr>
                        <tr>
                            <td>RoPEå¤„ç†</td>
                            <td>è™šæ‹Ÿâ†’å®é™…</td>
                            <td>è™šæ‹Ÿâ†’å®é™…</td>
                        </tr>
                        <tr>
                            <td><strong>æ€»æ—¶é—´</strong></td>
                            <td>~55ms</td>
                            <td>~5ms</td>
                        </tr>
                        <tr>
                            <td><strong>åŠ é€Ÿæ¯”</strong></td>
                            <td>1x</td>
                            <td><strong>12x</strong></td>
                        </tr>
                    </table>
                </div>

                <div class="performance">
                    ğŸ¯ <strong>å…³é”®ä¼˜åŒ–ï¼š</strong> Doc1 chunkä»ç¼“å­˜ç›´æ¥è·å–ï¼Œè·³è¿‡50msçš„KVè®¡ç®—ï¼Œä»…è€—æ—¶5msï¼ˆæ‹·è´+RoPEï¼‰
                </div>
            </div>

            <!-- æµç¨‹3ï¼šä½ç½®ç¼–ç å¤„ç† -->
            <div id="flow3" class="section">
                <h2>ğŸ¯ æµç¨‹3ï¼šä½ç½®ç¼–ç å¤„ç†ï¼ˆå…³é”®æµç¨‹ï¼‰</h2>

                <div class="description">
                    <h4>ä¸ºä»€ä¹ˆéœ€è¦è™šæ‹Ÿä½ç½®ï¼Ÿ</h4>
                    <p>ç”±äºchunkéœ€è¦åœ¨ä¸åŒè¯·æ±‚ä¸­å¤ç”¨ï¼Œè€Œä¸åŒè¯·æ±‚ä¸­chunkçš„å®é™…ä½ç½®å¯èƒ½ä¸åŒï¼Œå› æ­¤ï¼š</p>
                    <ul>
                        <li><strong>è®¡ç®—æ—¶</strong>ï¼šæ‰€æœ‰chunkåœ¨åŒä¸€è™šæ‹Ÿä½ç½®`[0, max_chunk_len)`è®¡ç®—KV</li>
                        <li><strong>ä½¿ç”¨æ—¶</strong>ï¼šé€šè¿‡PositionRemapperé‡æ˜ å°„åˆ°å®é™…ä½ç½®ï¼Œé‡æ–°åº”ç”¨RoPEç¼–ç </li>
                    </ul>
                </div>

                <h3>æ—¶åºå›¾ï¼šPositionRemapper.remap() æ ¸å¿ƒæµç¨‹</h3>
                <div class="diagram-container">
                    <div class="mermaid">
sequenceDiagram
    autonumber
    participant Caller as è°ƒç”¨è€…<br/>(GPUModelRunner)
    participant PositionRemapper as PositionRemapper<br/>(æ–°å¢)
    participant ChunkKVPool as ChunkKVPool<br/>(æ–°å¢)
    participant ChunkStorage as ChunkStorageManager<br/>(æ–°å¢)
    participant RoPEHelper as RoPEHelper<br/>(ç°æœ‰)
    participant NPUOps as NPU Operations<br/>(ç¡¬ä»¶åŠ é€Ÿ)

    Caller->>PositionRemapper: 1. remap(<br/>src_kv: ChunkKV,<br/>dst_position: int)

    Note over PositionRemapper: è¾“å…¥ï¼šsrc_kv = {<br/>block_ids: [100, 101],<br/>virtual_position: [0, 3),<br/>key_cache, value_cache<br/>}<br/>dst_position = 3

    PositionRemapper->>PositionRemapper: 2. æå–å…ƒæ•°æ®<br/>num_tokens = src_kv.num_tokens<br/>virtual_pos = src_kv.virtual_position

    PositionRemapper->>ChunkKVPool: 3. allocate_main_kv_pool(<br/>num_tokens,<br/>layer_idx,<br/>dtype)

    Note over ChunkKVPool: ä»ä¸»KV Poolåˆ†é…å—
    ChunkKVPool->>ChunkKVPool: 4. æŸ¥æ‰¾ç©ºé—²å—
    ChunkKVPool-->>PositionRemapper: 5. è¿”å› dst_block_ids [5000, 5001]

    PositionRemapper->>ChunkStorage: 6. get_chunk_kv(<br/>src_kv.block_ids)

    Note over ChunkStorage: ä»Chunk Poolè¯»å–KVæ•°æ®
    ChunkStorage->>ChunkStorage: 7. è¯»å–key_cache[block_ids]
    ChunkStorage->>ChunkStorage: 8. è¯»å–value_cache[block_ids]
    ChunkStorage-->>PositionRemapper: 9. è¿”å› {<br/>key: Tensor[3, num_heads, head_dim],<br/>value: Tensor[3, num_heads, head_dim]<br/>}

    PositionRemapper->>PositionRemapper: 10. å‡†å¤‡å®é™…ä½ç½®<br/>actual_positions = torch.arange(<br/>dst_position,<br/>dst_position + num_tokens<br/>)<br/>â†’ [3, 4, 5]

    Note over PositionRemapper: å…³é”®ï¼šé‡æ–°è®¡ç®—RoPE
    PositionRemapper->>RoPEHelper: 11. compute_rope_params(<br/>actual_positions,<br/>head_dim)

    RoPEHelper->>RoPEHelper: 12. è®¡ç®—cos, sin<br/>åŸºäºactual_positions [3, 4, 5]
    RoPEHelper-->>PositionRemapper: 13. è¿”å› {cos, sin}

    PositionRemapper->>NPUOps: 14. npu_kv_copy_and_apply_rope(<br/>src_key: Tensor,<br/>src_value: Tensor,<br/>dst_block_ids: [5000, 5001],<br/>cos: Tensor,<br/>sin: Tensor)

    Note over NPUOps: NPUåŠ é€Ÿï¼šæ‹·è´+RoPEä¸€æ­¥å®Œæˆ
    NPUOps->>NPUOps: 15. æ‹·è´KVæ•°æ®åˆ°ç›®æ ‡å—<br/>key[100,101] â†’ key[5000,5001]<br/>value[100,101] â†’ value[5000,5001]

    NPUOps->>NPUOps: 16. åº”ç”¨RoPEç¼–ç <br/>for i in [3, 4, 5]:<br/>  key[i] = key[i] * cos[i] + rotate(key[i]) * sin[i]<br/>  value[i] = value[i] * cos[i] + rotate(value[i]) * sin[i]

    Note over NPUOps: è¦†ç›–è™šæ‹Ÿä½ç½®çš„RoPEç¼–ç 
    NPUOps-->>PositionRemapper: 17. æ‹·è´+RoPEå®Œæˆ

    PositionRemapper->>PositionRemapper: 18. åˆ›å»ºRemappedChunkKV{<br/>block_ids: [5000, 5001],<br/>position: range(3, 6),<br/>is_remapped: true<br/>}

    PositionRemapper-->>Caller: 19. è¿”å› RemappedChunkKV

    Note over Caller: è¾“å‡ºï¼šé‡æ˜ å°„åçš„KV<br/>block_ids: [5000, 5001]<br/>position: [3, 4, 5]<br/>key/value: å·²åº”ç”¨å®é™…ä½ç½®RoPE
                    </div>
                </div>

                <h3>è™šæ‹Ÿä½ç½® vs å®é™…ä½ç½®</h3>
                <div class="diagram-container">
                    <div class="mermaid">
graph TB
    subgraph "è™šæ‹Ÿä½ç½®è®¡ç®—ï¼ˆChunk KV Cacheï¼‰"
        A1[sys_prompt: 0, 1, 2]
        A2[chunk1: 0, 1, 2, ..., 199]
        A3[chunk2: 0, 1, 2, ..., 199]
        A4[chunk3: 0, 1, 2, ..., 199]
    end

    subgraph "é‡æ˜ å°„ï¼ˆPositionRemapperï¼‰"
        B1[æ‹·è´KVæ•°æ®]
        B2[åº”ç”¨å®é™…ä½ç½®RoPE]
    end

    subgraph "å®é™…æ¨ç†ä½ç½®ï¼ˆç”¨äºAttentionï¼‰"
        C1[sys_prompt: 0, 1, 2]
        C2[chunk1: 3, 4, 5, ..., 202]
        C3[chunk2: 203, 204, ..., 402]
        C4[chunk3: 403, 404, ..., 602]
    end

    A1 --> B1
    A2 --> B1
    A3 --> B1
    A4 --> B1
    B1 --> B2
    B2 --> C1
    B2 --> C2
    B2 --> C3
    B2 --> C4

    style A1 fill:#e1f5ff
    style A2 fill:#e1f5ff
    style A3 fill:#e1f5ff
    style A4 fill:#e1f5ff
    style B1 fill:#fff3cd
    style B2 fill:#fff3cd
    style C1 fill:#d4edda
    style C2 fill:#d4edda
    style C3 fill:#d4edda
    style C4 fill:#d4edda
                    </div>
                </div>

                <div class="highlight">
                    <strong>å…³é”®åˆ›æ–°ï¼š</strong> è™šæ‹Ÿä½ç½®è®¡ç®—ä½¿å¾—chunkå¯ä»¥åœ¨ä¸åŒè¯·æ±‚ä¸­å¤ç”¨ï¼Œé‡æ˜ å°„æ—¶ä»…éœ€æ‹·è´KVæ•°æ®+é‡æ–°åº”ç”¨RoPEï¼ˆçº¦3-5msï¼‰ï¼Œæ— éœ€é‡æ–°è®¡ç®—ï¼ˆçº¦50msï¼‰ã€‚
                </div>
            </div>

            <!-- æµç¨‹4ï¼šAttention Maskæ„å»º -->
            <div id="flow4" class="section">
                <h2>ğŸ­ æµç¨‹4ï¼šChunk-Aware Attention Maskæ„å»º</h2>

                <div class="description">
                    <h4>ä¸ºä»€ä¹ˆéœ€è¦Chunk-Aware Attention Maskï¼Ÿ</h4>
                    <p>ä¸ºäº†å®ç°chunké—´çš„éš”ç¦»ï¼Œéœ€è¦è‡ªå®šä¹‰attention maskï¼š</p>
                    <ul>
                        <li><strong>sys_prompt</strong>ï¼šæ ‡å‡†causal attention</li>
                        <li><strong>chunk token</strong>ï¼šå¯çœ‹sys_prompt + åŒchunkå†…å‰åºtoken</li>
                        <li><strong>user_question</strong>ï¼šå¯çœ‹æ‰€æœ‰å†…å®¹</li>
                    </ul>
                </div>

                <h3>æ—¶åºå›¾</h3>
                <div class="diagram-container">
                    <div class="mermaid">
sequenceDiagram
    autonumber
    participant Caller as è°ƒç”¨è€…<br/>(GPUModelRunner)
    participant MaskBuilder as AttentionMaskBuilder<br/>(æ–°å¢)
    participant ChunkParser as ChunkTokenParser<br/>(æ–°å¢)

    Caller->>MaskBuilder: 1. get_chunk_aware_mask(<br/>chunk_boundaries: [(0,3), (3,203), (203,205)],<br/>seq_len: 205)

    Note over MaskBuilder: è¾“å…¥ï¼šchunkè¾¹ç•Œå®šä¹‰<br/>- sys_prompt: [0, 3)<br/>- chunk1: [3, 203)<br/>- question: [203, 205)

    MaskBuilder->>MaskBuilder: 2. åˆå§‹åŒ–chunk_idæ•°ç»„<br/>chunk_ids = torch.zeros(seq_len, dtype=int32)

    MaskBuilder->>MaskParser: 3. parse_chunk_types(<br/>chunk_boundaries)

    Note over MaskParser: è§£æchunkç±»å‹
    MaskParser->>MaskParser: 4. éå†chunk_boundaries<br/>for start, end in boundaries:<br/>  if i == 0: type = SYS_PROMPT<br/>  elif i == len-1: type = QUESTION<br/>  else: type = CHUNK

    MaskParser-->>MaskBuilder: 5. è¿”å› chunk_types<br/>[SYS_PROMPT, CHUNK, QUESTION]

    loop ä¸ºæ¯ä¸ªtokenåˆ†é…chunk_id
        MaskBuilder->>MaskBuilder: 6. åˆ†é…chunk_id<br/>tokens [0,1,2] â†’ chunk_id = -1 (sys_prompt)<br/>tokens [3..202] â†’ chunk_id = 0 (chunk1)<br/>tokens [203..204] â†’ chunk_id = -2 (question)
    end

    MaskBuilder->>MaskBuilder: 7. åˆå§‹åŒ–attention maskçŸ©é˜µ<br/>attn_mask = torch.zeros((seq_len, seq_len))

    loop æ„å»ºattention mask
        MaskBuilder->>MaskBuilder: 8. for i in range(seq_len):<br/>  for j in range(seq_len):<br/>    attn_mask[i,j] = compute_visibility(i, j, chunk_ids)

        Note over MaskBuilder: å¯è§æ€§è§„åˆ™<br/>if chunk_ids[i] == -1 (sys_prompt):<br/>  visible = (j <= i)  # æ ‡å‡†causal<br/>elif chunk_ids[i] == -2 (question):<br/>  visible = True  # å¯çœ‹æ‰€æœ‰<br/>elif chunk_ids[i] == 0 (chunk):<br/>  visible = (chunk_ids[j] == -1) or (chunk_ids[j] == 0 and j <= i)  # sys_prompt + åŒchunkcausal
    end

    MaskBuilder->>MaskBuilder: 9. è½¬æ¢ä¸ºäºŒè¿›åˆ¶mask<br/>attn_mask = attn_mask.float()<br/>attn_mask[attn_mask == 0] = float('-inf')<br/>attn_mask[attn_mask == 1] = 0.0

    MaskBuilder->>MaskBuilder: 10. æ·»åŠ causal mask<br/>triangular = torch.tril(torch.ones(seq_len, seq_len))<br/>attn_mask = attn_mask + triangular

    MaskBuilder-->>Caller: 11. è¿”å› attn_mask<br/>shape: (205, 205)

    Note over Caller: è¾“å‡ºï¼šchunk-aware attention mask<br/>- sys_prompt: æ ‡å‡†causal<br/>- chunk: å¯çœ‹sys_prompt+åŒchunk<br/>- question: å¯çœ‹æ‰€æœ‰
                    </div>
                </div>

                <h3>Attention MaskçŸ©é˜µç¤ºä¾‹ï¼ˆ10x10ï¼‰</h3>
                <div class="diagram-container">
                    <div class="mermaid">
graph LR
    subgraph "Attention MaskçŸ©é˜µ (ç®€åŒ–10x10)"
        A["<table>
            <tr>
                <th></th>
                <th>j=0</th>
                <th>j=1</th>
                <th>j=2</th>
                <th>j=3</th>
                <th>j=4</th>
                <th>j=5</th>
                <th>j=6</th>
                <th>j=7</th>
                <th>j=8</th>
                <th>j=9</th>
            </tr>
            <tr>
                <td><b>i=0</b></td>
                <td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td>
            </tr>
            <tr>
                <td><b>i=1</b></td>
                <td>0</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td>
            </tr>
            <tr>
                <td><b>i=2</b></td>
                <td>0</td><td>0</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td>
            </tr>
            <tr>
                <td><b>i=3</b></td>
                <td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>0</td><td>0</td><td>0</td><td>0</td>
            </tr>
            <tr>
                <td><b>i=4</b></td>
                <td>1</td><td>1</td><td>1</td><td>0</td><td>1</td><td>1</td><td>0</td><td>0</td><td>0</td><td>0</td>
            </tr>
            <tr>
                <td><b>i=5</b></td>
                <td>1</td><td>1</td><td>1</td><td>0</td><td>0</td><td>1</td><td>0</td><td>0</td><td>0</td><td>0</td>
            </tr>
            <tr>
                <td><b>i=6</b></td>
                <td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td>
            </tr>
            <tr>
                <td><b>i=7</b></td>
                <td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>0</td><td>1</td><td>1</td><td>1</td>
            </tr>
            <tr>
                <td><b>i=8</b></td>
                <td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>0</td><td>0</td><td>1</td><td>1</td>
            </tr>
            <tr>
                <td><b>i=9</b></td>
                <td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>0</td><td>0</td><td>0</td><td>1</td>
            </tr>
        </table>"]
    end

    style A fill:#f8f9fa
                    </div>
                </div>

                <div class="description">
                    <h4>ç¤ºä¾‹è¯´æ˜</h4>
                    <table>
                        <tr>
                            <th>Tokenç±»å‹</th>
                            <th>èŒƒå›´</th>
                            <th>å¯è§æ€§è§„åˆ™</th>
                        </tr>
                        <tr>
                            <td><strong>sys_prompt</strong></td>
                            <td>i=0, 1, 2</td>
                            <td>æ ‡å‡†causal attentionï¼ˆå¯çœ‹å‰é¢æ‰€æœ‰sys_prompt tokenï¼‰</td>
                        </tr>
                        <tr>
                            <td><strong>chunk1</strong></td>
                            <td>i=3, 4, 5</td>
                            <td>å¯çœ‹sys_prompt (0,1,2) + åŒchunkå†…causal</td>
                        </tr>
                        <tr>
                            <td><strong>question</strong></td>
                            <td>i=6, 7, 8, 9</td>
                            <td>å¯çœ‹æ‰€æœ‰å†…å®¹ï¼ˆsys_prompt + chunk1 + å‰åºquestionï¼‰</td>
                        </tr>
                    </table>
                </div>

                <div class="highlight">
                    <strong>å…³é”®ç‰¹æ€§ï¼š</strong> chunk1 (i=3,4,5) ä¸èƒ½çœ‹question (i=6,7,8,9)ï¼Œå®ç°chunké—´çš„æ­£ç¡®éš”ç¦»ã€‚
                </div>
            </div>

            <!-- æ¶‰åŠçš„ç±» -->
            <div id="classes" class="section">
                <h2>ğŸ“¦ æ¶‰åŠçš„ç±»</h2>

                <h3>æ–°å¢çš„ç±»ï¼ˆ7ä¸ªï¼‰</h3>

                <div class="class-info">
                    <h4>1. ChunkCacheEngine</h4>
                    <p><strong>è·¯å¾„ï¼š</strong> <code>vllm/v1/core/chunk_cache_engine.py</code></p>
                    <p><strong>èŒè´£ï¼š</strong> åè°ƒå±‚ï¼Œæä¾›ç»Ÿä¸€çš„lookup/store/clear API</p>
                    <p><strong>ä¸»è¦æ–¹æ³•ï¼š</strong></p>
                    <pre><code>def lookup(chunk_hash: bytes) -> ChunkKV | None
def store(chunk_hash: bytes, chunk_kv: ChunkKV) -> None
def clear() -> None
def get_stats() -> Dict[str, Any]</code></pre>
                </div>

                <div class="class-info">
                    <h4>2. ChunkTokenParser</h4>
                    <p><strong>è·¯å¾„ï¼š</strong> <code>vllm/v1/core/chunk_token_parser.py</code></p>
                    <p><strong>èŒè´£ï¼š</strong> è§£æchunked promptï¼Œè¯†åˆ«chunkè¾¹ç•Œï¼Œè®¡ç®—å†…å®¹å“ˆå¸Œ</p>
                    <p><strong>ä¸»è¦æ–¹æ³•ï¼š</strong></p>
                    <pre><code>def parse(tokens: list[int], separator: str) -> ChunkedPrompt
def compute_hash(tokens: list[int]) -> bytes  # XXHash128
def validate(prompt_str: str) -> bool</code></pre>
                </div>

                <div class="class-info">
                    <h4>3. ChunkStorageManager</h4>
                    <p><strong>è·¯å¾„ï¼š</strong> <code>vllm/v1/core/chunk_storage_manager.py</code></p>
                    <p><strong>èŒè´£ï¼š</strong> ç®¡ç†chunkå­˜å‚¨ï¼Œåˆ†é…/é‡Šæ”¾å­˜å‚¨å—</p>
                    <p><strong>ä¸»è¦æ–¹æ³•ï¼š</strong></p>
                    <pre><code>def allocate(chunk_key: ChunkKey, kv_shape: tuple) -> list[int]
def free(block_ids: list[int]) -> None
def get(chunk_key: ChunkKey) -> ChunkKV | None
def put(chunk_key: ChunkKey, chunk_kv: ChunkKV) -> None</code></pre>
                </div>

                <div class="class-info">
                    <h4>4. ChunkHashIndex</h4>
                    <p><strong>è·¯å¾„ï¼š</strong> <code>vllm/v1/core/chunk_hash_index.py</code></p>
                    <p><strong>èŒè´£ï¼š</strong> å†…å®¹å“ˆå¸Œâ†’chunkæ˜ å°„ç´¢å¼•ï¼ŒO(1)æŸ¥æ‰¾</p>
                    <p><strong>æ•°æ®ç»“æ„ï¼š</strong></p>
                    <pre><code>index: Dict[bytes, ChunkKV]  # content_hash -> ChunkKV</code></pre>
                    <p><strong>ä¸»è¦æ–¹æ³•ï¼š</strong></p>
                    <pre><code>def lookup(chunk_hash: bytes) -> ChunkKV | None
def insert(chunk_hash: bytes, chunk_kv: ChunkKV) -> None
def remove(chunk_hash: bytes) -> None</code></pre>
                </div>

                <div class="class-info">
                    <h4>5. ChunkKVConnector</h4>
                    <p><strong>è·¯å¾„ï¼š</strong> <code>vllm/v1/core/chunk_kv_connector.py</code></p>
                    <p><strong>èŒè´£ï¼š</strong> GPUâ†”CPUæ•°æ®ä¼ è¾“</p>
                    <p><strong>ä¸»è¦æ–¹æ³•ï¼š</strong></p>
                    <pre><code>def to_cpu(gpu_kv: ChunkKV) -> MemoryObj
def to_gpu(chunk_kv: ChunkKV) -> torch.Tensor</code></pre>
                </div>

                <div class="class-info">
                    <h4>6. PositionRemapper</h4>
                    <p><strong>è·¯å¾„ï¼š</strong> <code>vllm/v1/worker/position_remapper.py</code></p>
                    <p><strong>èŒè´£ï¼š</strong> KVæ‹·è´+RoPEé‡æ–°ç¼–ç ï¼ˆæ ¸å¿ƒæ–¹æ³•ï¼‰</p>
                    <p><strong>ä¸»è¦æ–¹æ³•ï¼š</strong></p>
                    <pre><code>def remap(src_kv: ChunkKV, dst_position: int) -> RemappedChunkKV
def release(block_ids: list[int]) -> None</code></pre>
                </div>

                <div class="class-info">
                    <h4>7. ChunkKVPool</h4>
                    <p><strong>è·¯å¾„ï¼š</strong> <code>vllm/v1/worker/chunk_kv_pool.py</code></p>
                    <p><strong>èŒè´£ï¼š</strong> ç‹¬ç«‹çš„æ˜¾å­˜æ± ç®¡ç†ï¼ˆé»˜è®¤2GBï¼‰</p>
                    <p><strong>ä¸»è¦æ–¹æ³•ï¼š</strong></p>
                    <pre><code>def allocate(num_tokens: int) -> list[int]
def allocate_main_kv(num_tokens: int) -> list[int]
def free(block_ids: list[int]) -> None
def get_stats() -> Dict[str, Any]</code></pre>
                </div>

                <h3>ä¿®æ”¹çš„ç±»ï¼ˆ6ä¸ªï¼‰</h3>

                <div class="class-info">
                    <h4>1. InputProcessor</h4>
                    <p><strong>è·¯å¾„ï¼š</strong> <code>vllm/v1/engine/input_processor.py</code></p>
                    <p><strong>ä¿®æ”¹å†…å®¹ï¼š</strong> æ£€æµ‹`# #`åˆ†éš”ç¬¦ï¼Œè§£æchunked prompt</p>
                    <p><strong>æ–°å¢æ–¹æ³•ï¼š</strong></p>
                    <pre><code>def _detect_chunked_prompt(self, prompt_str: str) -> bool
def parse_chunked_prompt(self, tokens: list[int]) -> ChunkedPrompt</code></pre>
                </div>

                <div class="class-info">
                    <h4>2. GPUModelRunner</h4>
                    <p><strong>è·¯å¾„ï¼š</strong> <code>vllm/v1/worker/gpu_model_runner.py</code></p>
                    <p><strong>ä¿®æ”¹å†…å®¹ï¼š</strong> æ–°å¢chunkå¤„ç†æ–¹æ³•</p>
                    <p><strong>æ–°å¢æ–¹æ³•ï¼š</strong></p>
                    <pre><code>def parse_chunked_prompt(self, request: Request) -> ChunkedPrompt
def get_or_compute_chunks(self, chunked_prompt: ChunkedPrompt) -> list[RemappedChunkKV]
def compute_chunk_kv(self, tokens: list[int], position: int) -> ChunkKV</code></pre>
                </div>

                <div class="class-info">
                    <h4>3. AscendSFABackend</h4>
                    <p><strong>è·¯å¾„ï¼š</strong> <code>vllm-ascend/attention/sfa_v1.py</code></p>
                    <p><strong>ä¿®æ”¹å†…å®¹ï¼š</strong> é›†æˆchunk-aware attention mask</p>
                    <p><strong>ä¿®æ”¹æ–¹æ³•ï¼š</strong></p>
                    <pre><code>def forward(self, query, key, value, chunk_attn_mask, kv_blocks):
    # åº”ç”¨chunk-aware attention mask
    # æ‰§è¡Œæ³¨æ„åŠ›è®¡ç®—</code></pre>
                </div>

                <div class="class-info">
                    <h4>4. AttentionMaskBuilder</h4>
                    <p><strong>è·¯å¾„ï¼š</strong> <code>vllm-ascend/attention/attention_mask.py</code></p>
                    <p><strong>ä¿®æ”¹å†…å®¹ï¼š</strong> æ–°å¢chunk-aware attention maskç”Ÿæˆ</p>
                    <p><strong>æ–°å¢æ–¹æ³•ï¼š</strong></p>
                    <pre><code>@staticmethod
def get_chunk_aware_mask(
    chunk_boundaries: list[tuple[int, int]],
    seq_len: int
) -> torch.Tensor:
    """æ„å»ºchunkéš”ç¦»attention mask"""</code></pre>
                </div>

                <div class="class-info">
                    <h4>5. VllmConfig</h4>
                    <p><strong>è·¯å¾„ï¼š</strong> <code>vllm/config/vllm_config.py</code></p>
                    <p><strong>ä¿®æ”¹å†…å®¹ï¼š</strong> æ·»åŠ ChunkCacheConfigé…ç½®ç±»</p>
                    <pre><code>@dataclass
class ChunkCacheConfig:
    enable_chunk_cache: bool = False
    chunk_separator: str = " # # "
    chunk_cache_gpu_memory_fraction: float = 0.15
    chunk_hash_algorithm: str = "xxhash"</code></pre>
                </div>

                <div class="class-info">
                    <h4>6. AscendStoreConnector</h4>
                    <p><strong>è·¯å¾„ï¼š</strong> <code>vllm-ascend/distributed/kvpool/ascend_store_connector.py</code></p>
                    <p><strong>ä¿®æ”¹å†…å®¹ï¼š</strong> æ‰©å±•æ”¯æŒchunk KVä¼ è¾“</p>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>ä½ç½®æ— å…³Chunkç¼“å­˜è®¾è®¡æ–¹æ¡ˆ - æµç¨‹æ—¶åºå›¾</p>
            <p>Generated with Claude Code - Mermaid.js</p>
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            sequence: {
                diagramMarginX: 50,
                diagramMarginY: 10,
                actorMargin: 50,
                width: 150,
                height: 65,
                boxMargin: 10,
                boxTextMargin: 5,
                noteMargin: 10,
                messageMargin: 35,
                mirrorActors: true,
                useMaxWidth: true
            },
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });
    </script>
</body>
</html>